<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/api.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="TLS.connect.html">connect</a><ul class='methods'><li data-type='method'><a href="TLS.connect.html#api">api</a></li><li data-type='method'><a href="TLS.connect.html#getTank">getTank</a></li><li data-type='method'><a href="TLS.connect.html#getTankNames">getTankNames</a></li><li data-type='method'><a href="TLS.connect.html#getTanks">getTanks</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="TLS.html">TLS</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/api.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var net = Npm.require('net');
var future = Npm.require('fibers/future');

var ETX = String.fromCharCode(3);

/**
 * TLS API Interface
 * @constructor
 * @param {String} ip TLS IP Address
 * @param {Number} port TLS Port
 * @param {Array} tankNames Product List
 */
TLS.connect = function TLS(ip, port, tankNames) {
	var fut = new future();

	this.ip = ip;
	this.port = port;

	if (typeof tankNames !== 'undefined') {
		this.tankNames = tankNames;
		fut.return();
	} else {
		this.tankNames = this.getTankNames(fut.return);
	}

	return fut.wait();
};

/**
 * Returns an array of tank names
 * @param  {Array} tanks TLS tanks
 * @param  {Function} [callback] callback function
 */
TLS.connect.prototype.getTankNames = function getTankNames(cb) {
	var res = this.api('200', cb);
  res = TLS.utils.tanks.names(res);
  return res;
};

/**
 * Returns an array of tanks objects
 * @param  {Array} tanks TLS tanks
 * @param  {Function} [callback] callback function
 */
TLS.connect.prototype.getTanks = function getTanks(cb) {
	var t = this.api('i20100', cb);
	return TLS.utils.tanks.extract(t);
};

/**
 * Returns data for the specified tankId
 * @param  {String} tankId TLS tank number
 * @param  {Function} [callback] callback function
 */
TLS.connect.prototype.getTank = function getTank(tankId, cb) {
	this.api('i20100', {id: tankId}, cb);
};

/**
 * Make a function call
 * @param  {String} code TLS function code
 * @param  {Object} [options] Set call options
* @param  {Function} [callback] Function to execute on completion
 */
TLS.connect.prototype.api = function api(command, options, callback) {
  var fut = new future();
  var responseString = '';
  var _tls = this;

	if (typeof options === 'function' &amp;&amp; !callback) {
		callback = options;
		options = undefined;
	}

  command = String.fromCharCode(1) + command;

  var client = net.connect(_tls.port, _tls.ip, function() {
    console.log(_tls.ip + ' connected (' + command + ')');
    client.write(command);
  });

  client.setEncoding('ascii');
  client.setTimeout(2000);

  client.on('readable', function() {
    var chunk;
    while (null !== (chunk = client.read())) {
      var s = chunk.toString();
      if (s.indexOf(ETX) != -1) {
        client.end();
        fut.return(responseString);
        break;
      } else {
        responseString += s;
      }
    }
  });

  client.on('end', function() {
    console.log(_tls.ip + ' disconnected');
		setTimeout(function() {
			typeof callback === 'function' &amp;&amp; callback();
		}, 100);
  });

  client.on('timeout', function() {
    console.log(_tls.ip + ' timeout');
    client.end();
  });

  client.on('error', function(err) {
    fut.return(err);
  });

  return fut.wait();
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Sun Jun 28 2015 03:52:06 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
